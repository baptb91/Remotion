name: Render Remotion Video
on:
  workflow_dispatch:
    inputs:
      beats:
        description: 'Beats (JSON array, ex: [0.5,1.2,2.0])'
        required: true
      audio_url:
        description: 'URL du fichier audio'
        required: true
      audio_duration:
        description: 'Durée audio (secondes)'
        required: true

jobs:
  render:
    runs-on: ubuntu-latest
    container:
      image: node:18
      options: --user root
    steps:
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y wget gnupg ca-certificates procps libxss1 libgconf-2-4 libxrandr2 libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libgtk-3-0 libgdk-pixbuf2.0-0 libxcomposite1 libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 libcups2 libxrandr2 libasound2 libpangocairo-1.0-0 libatk1.0-0 libcairo-gobject2 libdrm2 libxss1 libgbm1

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install -D typescript ts-loader @types/react @types/react-dom

      - name: Setup Chrome/Browser
        run: |
          # Installation manuelle du navigateur
          npx remotion browser ensure --log=verbose
          # Alternative si la première commande échoue
          sudo apt-get update
          sudo apt-get install -y chromium-browser
        continue-on-error: false

      - name: Create public directory
        run: mkdir -p public

      - name: Download audio
        run: curl -L "${{ github.event.inputs.audio_url }}" -o public/audio.mp3

      - name: Render video
        run: |
          npx remotion render src/index.tsx MyComp out/video.mp4 \
            --props='{"beats":${{ github.event.inputs.beats }},"audioDuration":"${{ github.event.inputs.audio_duration }}","audioSrc":"audio.mp3"}' \
            --log=verbose \
            --bundle-cache=false
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: rendered-video
          path: out/video.mp4
